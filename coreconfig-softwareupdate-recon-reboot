#!/bin/bash
##################################################################
# 
# Check the 'last' log for a reboot and perform a recon if a SUDONE
# flag file has been generated by the softwareupdate policy on or 
# around the same day.
#
# Date: Fri 24 May 2019 15:37:25 BST
# Version: 0.1.1
# Creator: ganders1
#
##################################################################

containsElement () {
  local e match="$1"
  shift
  for e; do [[ "$e" == "$match" ]] && echo 0; done
  echo 1
}

# Look in the last log for a reboot in the last 20 entries and feed into array. 
Reboot_Array=( `last -20 | grep reboot | awk '{print $4$5}'` )

# Get the day/month for today.
Day_Today=$( date "+%b%d" )

# Check if the array contains Day_Today
Day_Match=$( containsElement "${Day_Today}" "${Reboot_Array[@]}" )

# Check for the SUDONE file, if it exists perform a recon
if ! [ "${Day_Match}" == "1" ]; then
	if [ -f /Library/MacSD/SUDONE ]; then
		echo "This Mac has rebooted after a softwareupdate, performing recon."
		/usr/local/bin/jamf recon
		echo "Removing SU flag file."
		rm -f /Library/MacSD/SUDONE
	else
    	echo "This Mac has rebooted but no softwareupdate flag file found. No recon necessary."
	fi
fi

exit 0;
